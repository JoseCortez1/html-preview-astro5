---
// HTMLPreviewer.astro
---
<div class="html-previewer" role="region" aria-label="Editor HTML con vista previa en tiempo real">

  <div class="editor-container" role="region" aria-label="Editor de código">
    <label for="monaco-editor" class="sr-only">Editor de código HTML</label>
    <div id="monaco-editor" role="textbox" aria-label="Editor de código HTML. Escribe tu código aquí para ver la vista previa en tiempo real." aria-multiline="true" tabindex="0"></div>
  </div>
  <div class="preview-container" role="region" aria-label="Vista previa del HTML">
    <label for="preview-frame" class="sr-only">Vista previa del código HTML</label>
    <iframe 
      id="preview-frame" 
      title="Vista previa del código HTML renderizado"
      aria-label="Vista previa del código HTML. Muestra el resultado de tu código en tiempo real."
      sandbox="allow-same-origin allow-scripts"
    ></iframe>
  </div>
</div>

<style>
  :root{
    --orange-400: #ff8904;
  }

	.header{
		font-weight: bold;
		font-size: 2rem;
		text-align: center;
		padding: 1rem 0;
	}

	/* Screen reader only - para accesibilidad */
	.sr-only {
		position: absolute;
		width: 1px;
		height: 1px;
		padding: 0;
		margin: -1px;
		overflow: hidden;
		clip: rect(0, 0, 0, 0);
		white-space: nowrap;
		border-width: 0;
	}

	.html-previewer {
		display: grid;
		grid-template-columns: 60% auto; 
		height: 80vh;
		background: var(--orange-400);
		border-radius: 8px;
		margin: 0 1rem;
		padding: 0.2rem;
		overflow: hidden;
		@media (max-width: 768px) {
			grid-template-columns: 1fr; 
			min-height: 100vh; 
		}
	}

	.editor-container {
		border-right: 1px solid var(--orange-400);
		position: relative;
	}

	.preview-container {
		flex: 1;
		background: white;
		position: relative;
	}

	#monaco-editor {
		height: 100%;
		width: 100%;
		outline: none;
	}

	#monaco-editor:focus-visible {
		outline: 3px solid var(--orange-400);
		outline-offset: -3px;
	}

	#preview-frame {
		width: 100%;
		height: 100%;
		border: none;
		border-radius: 0 8px 8px 0;
		display: block;
	}

	/* Mejorar contraste y accesibilidad */
	@media (prefers-reduced-motion: reduce) {
		* {
			animation-duration: 0.01ms !important;
			animation-iteration-count: 1 !important;
			transition-duration: 0.01ms !important;
		}
	}
</style>

<script>
  import * as monaco from 'monaco-editor';

  // Configuración inicial del editor
  const initialHTML = `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vista Previa</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        h1 {
            color: #333;
        }
    </style>
</head>
<body>
    <h1>Preview editor!</h1>
    <p>Edita el HTML en el editor de la izquierda para ver los cambios aquí.</p>
</body>
</html>`;

  // Add this configuration BEFORE Monaco is initialized
  window.MonacoEnvironment = {
    getWorkerUrl: function(moduleId, label) {
      if (label === 'json') {
        return '/monaco-editor/min/vs/language/json/json.worker.js';
      }
      if (label === 'css' || label === 'scss' || label === 'less') {
        return '/monaco-editor/min/vs/language/css/css.worker.js';
      }
      if (label === 'html' || label === 'handlebars' || label === 'razor') {
        return '/monaco-editor/min/vs/language/html/html.worker.js';
      }
      if (label === 'typescript' || label === 'javascript') {
        return '/monaco-editor/min/vs/language/typescript/ts.worker.js';
      }
      return '/monaco-editor/min/vs/editor/editor.worker.js';
    }
  };

  // Declarar tipo para previewTimeout
  declare global {
    interface Window {
      previewTimeout?: ReturnType<typeof setTimeout>;
    }
  }

  // Crear el editor Monaco
  const monacoEditorElement = document.getElementById('monaco-editor');
  if (!monacoEditorElement) {
    throw new Error('Monaco editor element not found');
  }

  const editor = monaco.editor.create(monacoEditorElement, {
    value: initialHTML,
    language: 'html',
    automaticLayout: true,
    fontSize: 14,
    wordWrap: 'on',
	scrollBeyondLastLine: false,

  });

  // Función para actualizar la vista previa
  function updatePreview() {
    const htmlContent = editor.getValue();
    const previewFrame = document.getElementById('preview-frame') as HTMLIFrameElement | null;
    
    if (!previewFrame) {
      console.error('Preview frame not found');
      return;
    }
    
    // Crear un blob con el contenido HTML
    const blob = new Blob([htmlContent], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    
    // Actualizar el src del iframe
    previewFrame.src = url;
    
    // Limpiar el URL anterior después de un tiempo
    setTimeout(() => {
      URL.revokeObjectURL(url);
    }, 1000);
  }

  // Actualizar vista previa inicial
  updatePreview();

  // Escuchar cambios en el editor
  editor.onDidChangeModelContent(() => {
    // Debounce para evitar actualizaciones excesivas
    if (window.previewTimeout) {
      clearTimeout(window.previewTimeout);
    }
    window.previewTimeout = setTimeout(updatePreview, 300);
  });

  // Limpiar recursos al salir
  window.addEventListener('beforeunload', () => {
    editor.dispose();
  });
</script>