---
import { getTranslations, type Locale } from '../i18n/translations';
import { getCurrentLocale, getLocalizedPath, getAlternateLocales } from '../i18n/utils';

interface Props {
  locale?: Locale;
}

const locale = Astro.props.locale || getCurrentLocale(Astro.url);
const t = getTranslations(locale);
const currentPath = Astro.url.pathname;

// FunciÃ³n para determinar si una ruta es la activa
const isActive = (path: string) => {
    const normalizedPath = path === '/' ? '/' : getLocalizedPath(path, locale);
    if (normalizedPath === '/' && currentPath === '/') return true;
    if (normalizedPath !== '/' && currentPath.startsWith(normalizedPath)) return true;
    return false;
}

// Determinar clases para cada enlace
const homeIsActive = isActive('/');
const aboutIsActive = isActive('/about');

const getLocalizedHref = (path: string) => {
  return getLocalizedPath(path, locale);
}

// Obtener idiomas alternativos para el dropdown
const alternateLocales = getAlternateLocales(locale, currentPath);
---

<header role="banner" class="bg-[var(--bg-primary)] transition-colors duration-300">
    <nav class="flex items-center justify-between p-4 shadow-sm border-b border-[var(--border-color)] bg-[var(--bg-primary)] transition-colors duration-300" role="navigation" aria-label={t.nav.skipToContent}>
        <div>
            <a 
                class="text-sm gap-4 font-semibold hover:!text-orange-600 dark:hover:text-gray-100 !text-gray-900 dark:!text-gray-200 flex items-center focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2 rounded transition-colors" 
                href={getLocalizedHref('/')}
                aria-label="HTML Preview Editor - {t.nav.home}"
            >
                <svg class="w-5 h-6 !text-orange-600 dark:!text-orange-400" viewBox="0 0 896 1024" aria-hidden="true" focusable="false"><path fill="currentColor" d="M831.405 1024h-767q-27 0-45.5-18.5T.405 960V65q0-27 18.5-45.5T64.405 1h448v352q0 13 9 22.5t23 9.5h351v575q0 27-18.5 45.5t-45.5 18.5m-459-440q12-12 12-30t-12-30.5t-29-12.5t-29 13l-175 149q-12 13-12 30.5t12 30.5l175 149q12 13 29 13t29-12.5t12-30.5t-12-30l-146-119zm384 89l-174-149q-12-13-29-13t-29 12.5t-12 30.5t12 30l145 120l-145 119q-12 12-12 30t12 30.5t29 12.5t29-13l174-149q13-13 13-30.5t-13-30.5m-180-673q26 0 44 18l256 257q19 19 19 46h-319z"/></svg>
                <span>HTML preview</span>
            </a>
        </div>
        <div class="flex items-center gap-4">
          <ul class="flex items-center gap-4" role="menubar">
              <li role="none">
                  <a 
                      class={`text-sm font-semibold transition-colors ${
                        homeIsActive 
                          ? 'text-orange-600 dark:text-orange-400 border-b-2 border-orange-600 dark:border-orange-400' 
                          : 'text-gray-900 dark:text-gray-200 hover:text-orange-600 dark:hover:text-orange-400 hover:border-b-0'
                      }`}
                      href={getLocalizedHref('/')}
                      role="menuitem"
                      aria-current={homeIsActive ? 'page' : undefined}
                  >
                      {t.nav.home}
                  </a>
              </li>
              <li role="none">
                  <a 
                      class={`text-sm font-semibold transition-colors ${
                        aboutIsActive 
                          ? 'text-orange-600 dark:text-orange-400 border-b-2 border-orange-600 dark:border-orange-400' 
                          : 'text-gray-900 dark:text-gray-200 hover:text-orange-600 dark:hover:text-orange-400 hover:border-b-0'
                      }`}
                      href={getLocalizedHref('/about')}
                      role="menuitem"
                      aria-current={aboutIsActive ? 'page' : undefined}
                  >
                      {t.nav.about}
                  </a>
              </li>
          </ul>
          <button
            id="theme-toggle"
            class="p-2 rounded-lg !text-gray-900 dark:!text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2 transition-colors"
            aria-label="Toggle dark mode"
            title="Toggle dark mode"
          >
            <svg id="theme-icon-light" class="w-5 h-5 hidden dark:block" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
            </svg>
            <svg id="theme-icon-dark" class="w-5 h-5 block dark:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
            </svg>
          </button>
          <div class="relative" role="group" aria-label={t.lang.select}>
            <button
              id="language-dropdown-button"
              type="button"
              class="flex items-center gap-1 text-sm font-semibold text-gray-900 dark:text-gray-200 bg-transparent border border-gray-400 dark:border-gray-600 rounded px-2 py-1 hover:bg-gray-100 dark:hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2 cursor-pointer transition-colors"
              aria-label={t.lang.select}
              aria-expanded="false"
              aria-haspopup="true"
            >
              <span>{locale.toUpperCase()}</span>
              <svg class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div
              id="language-dropdown-menu"
              class="hidden absolute right-0 mt-2 w-20 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md shadow-lg z-50 overflow-hidden"
              role="menu"
              aria-orientation="vertical"
            >
              {alternateLocales.map(({ locale: altLocale, url }) => (
                <a
                  href={url}
                  class="block px-3 py-2 text-sm font-semibold text-gray-900 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                  role="menuitem"
                >
                  {altLocale.toUpperCase()}
                </a>
              ))}
            </div>
          </div>
          <script>
            (function() {
              const button = document.getElementById('language-dropdown-button');
              const menu = document.getElementById('language-dropdown-menu');
              
              if (!button || !menu) return;
              
              // Toggle del dropdown
              button.addEventListener('click', (e) => {
                e.stopPropagation();
                const isOpen = menu.classList.contains('hidden');
                
                if (isOpen) {
                  menu.classList.remove('hidden');
                  button.setAttribute('aria-expanded', 'true');
                  button.querySelector('svg')?.classList.add('rotate-180');
                } else {
                  menu.classList.add('hidden');
                  button.setAttribute('aria-expanded', 'false');
                  button.querySelector('svg')?.classList.remove('rotate-180');
                }
              });
              
              // Cerrar al hacer click fuera
              document.addEventListener('click', (e) => {
                if (!button.contains(e.target as Node) && !menu.contains(e.target as Node)) {
                  menu.classList.add('hidden');
                  button.setAttribute('aria-expanded', 'false');
                  button.querySelector('svg')?.classList.remove('rotate-180');
                }
              });
              
              // Cerrar con Escape
              document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && !menu.classList.contains('hidden')) {
                  menu.classList.add('hidden');
                  button.setAttribute('aria-expanded', 'false');
                  button.querySelector('svg')?.classList.remove('rotate-180');
                  button.focus();
                }
              });
            })();
          </script>
        </div>
    </nav>
</header>